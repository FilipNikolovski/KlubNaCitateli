
/*!
 * tokens - jQuery plugin that turns a text field into a tokenized autocomplete
 * v0.5.0
 * https://github.com/firstandthird/tokens/
 * copyright First + Third 2014
 * MIT License
*/
!function(a,b){var c=0,d=function(a){this.obj=a};d.prototype.__init=function(a){b.extend(this,this.obj),this.id=c++,this.namespace=".fidel"+this.id,this.obj.defaults=this.obj.defaults||{},b.extend(this,this.obj.defaults,a),b("body").trigger("FidelPreInit",this),this.setElement(this.el||b("<div/>")),this.init&&this.init(),b("body").trigger("FidelPostInit",this)},d.prototype.eventSplitter=/^(\w+)\s*(.*)$/,d.prototype.setElement=function(a){this.el=a,this.getElements(),this.dataElements(),this.delegateEvents(),this.delegateActions()},d.prototype.find=function(a){return this.el.find(a)},d.prototype.proxy=function(a){return b.proxy(a,this)},d.prototype.getElements=function(){if(this.elements)for(var a in this.elements){var b=this.elements[a];this[b]=this.find(a)}},d.prototype.dataElements=function(){var a=this;this.find("[data-element]").each(function(c,d){var e=b(d),f=e.data("element");a[f]=e})},d.prototype.delegateEvents=function(){if(this.events)for(var a in this.events){var b=this.events[a],c=a.match(this.eventSplitter),d=c[1],e=c[2],f=this.proxy(this[b]);""===e?this.el.on(d+this.namespace,f):this[e]&&"function"!=typeof this[e]?this[e].on(d+this.namespace,f):this.el.on(d+this.namespace,e,f)}},d.prototype.delegateActions=function(){var a=this;a.el.on("click"+this.namespace,"[data-action]",function(c){var d=b(this),e=d.attr("data-action");a[e]&&a[e](c,d)})},d.prototype.on=function(a,b){this.el.on(a+this.namespace,b)},d.prototype.one=function(a,b){this.el.one(a+this.namespace,b)},d.prototype.emit=function(a,b,c){var d=c?this.namespace:"";this.el.trigger(a+d,b)},d.prototype.hide=function(){if(this.views)for(var a in this.views)this.views[a].hide();this.el.hide()},d.prototype.show=function(){if(this.views)for(var a in this.views)this.views[a].show();this.el.show()},d.prototype.destroy=function(){this.el.empty(),this.emit("destroy"),this.el.unbind(this.namespace)},d.declare=function(a){var b=function(a,b){this.__init(a,b)};return b.prototype=new d(a),b},d.onPreInit=function(a){b("body").on("FidelPreInit",function(b,c){a.call(c)})},d.onPostInit=function(a){b("body").on("FidelPostInit",function(b,c){a.call(c)})},a.Fidel=d}(window,window.jQuery||window.Zepto),function(a){a.declare=function(b,c){a.fn[b]=function(){var d,e,f=Array.prototype.slice.call(arguments),g=f.shift();return e=this.each(function(){var e=a(this),h=e.data(b);if(!h){var i=Fidel.declare(c),j=a.extend({},g,{el:e});h=new i(j),e.data(b,h)}"string"==typeof g&&(d=h[g].apply(h,f))}),"undefined"!=typeof d?d:e},a.fn[b].defaults=c.defaults||{}},a.Fidel=window.Fidel}(jQuery),function(a){function b(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}a.declare("tokens",{defaults:{formatSuggestion:function(a,c){var d="("+b(c)+")";return a.replace(new RegExp(d,"gi"),"<strong>$1</strong>")},search:function(a,b,c){return-1!==a.toLowerCase().indexOf(c.toLowerCase())},query:function(b,c){var d=b.toLowerCase(),e=this,f=a.grep(this.source,function(a){return e.search(a,b,d)});c.apply(this,[f])},validate:function(){return!0},keyCode:{UP:38,DOWN:40,BACKSPACE:8,TAB:9,ENTER:13,ESC:27,COMMA:188,SPACE:32},texts:{"close-text":"Ã—","type-suggestions":"Type to search values","no-results":"There are no results matching","add-result":'Add "%s" to the list',"invalid-format":"%s is not the correct format","existing-item":"%s is already selected"},cssClasses:{"token-list":"tokens-token-list","list-input-holder":"tokens-list-input-holder","list-token-holder":"tokens-list-token-holder","input-text":"tokens-input-text","delete-anchor":"tokens-delete-token","suggestion-selector":"tokens-suggestion-selector","suggestions-list-element":"tokens-suggestions-list-element","highlighted-suggestion":"tokens-highlighted-suggestion","add-new-result":"tokens-add-new-result","existing-item":"tokens-existing-item"},maxSelected:0,showSuggestionOnFocus:!0,showMessageOnNoResults:!0,allowAddingNoSuggestion:!0,cleanInputOnHide:!0,suggestionsZindex:999,source:[],initValue:[],minChars:0},_getTarget:function(b){return a(b.currentTarget||b.toElement)},_setAttributes:function(){this.el.hide()},_createStructure:function(){this.list=a("<ul>").addClass(this.cssClasses["token-list"]),this.listInputHolder=a("<li>").addClass(this.cssClasses["list-input-holder"]).appendTo(this.list),this.inputText=a('<input type="text">').attr("autocomplete","off").attr("autocapitalize","off").addClass(this.cssClasses["input-text"]).appendTo(this.listInputHolder),this.list.insertBefore(this.el),this._createTester(),this._createSuggestionsStructure()},_createSuggestionsStructure:function(){this.suggestionsHolder=a("<div>").addClass(this.cssClasses["suggestion-selector"]).css({position:"absolute","z-index":this.suggestionsZindex}).hide().appendTo(a("body"))},_createTester:function(){this.inputResizer=a("<tester>").css({position:"absolute",top:-9999,left:-9999,width:"auto","font-size":this.inputText.css("font-size"),"font-family":this.inputText.css("font-family"),"font-weight":this.inputText.css("font-weight"),"letter-spacing":this.inputText.css("letter-spacing"),whitespace:"nowrap"}).insertAfter(this.inputText)},_focusInput:function(){var a=this;setTimeout(function(){a.inputText.focus()},10)},_onDeleteClick:function(a){a.stopImmediatePropagation(),this._removeNode(this._getTarget(a).parent())},_onListClick:function(){this._focusInput(),this._showTypeSuggestion()},_onKeyDown:function(a){switch(a.keyCode){case this.keyCode.UP:this._prevSuggestion();break;case this.keyCode.DOWN:this._nextSuggestion();break;case this.keyCode.ESC:this.el.val(this.currentValue),this._hideSuggestions();break;case this.keyCode.TAB:case this.keyCode.ENTER:case this.keyCode.COMMA:case this.keyCode.SPACE:this._selectSuggestion();break;case this.keyCode.BACKSPACE:return void this._deleteLastIfEmpty();default:return}a.stopImmediatePropagation(),a.preventDefault()},_onKeyUp:function(a){switch(a.keyCode){case this.keyCode.UP:case this.keyCode.DOWN:return}this._suggestionChanged()},_onMouseOver:function(a){var b=this._getTarget(a);this._activateSuggestion(b.data("index"))},_suggestionChanged:function(){var a=this.inputText.val();a!==this.suggestionValue&&(this.inputText.val(a),this.suggestionValue=a,this.selectedSuggestion=-1,a.length>this.minChars&&this._updateSuggestions())},_deleteLastIfEmpty:function(){""===this.inputText.val()&&this._deleteLastToken()},_deleteLastToken:function(){var a=this.currentValue.slice(0),b=a.pop();this.removeValue(b)},_nextSuggestion:function(){this.selectedSuggestion!==this.suggestions.length-1&&this._adjustPosition(this.selectedSuggestion+1)},_prevSuggestion:function(){-1!==this.selectedSuggestion&&this._adjustPosition(this.selectedSuggestion-1)},_updateSuggestions:function(){var b=this;this.query.call(b,b.suggestionValue,function(b){var c=b.length;if(b&&a.isArray(b)&&c){var d=a("<ul>");this.suggestions=b;for(var e=0;c>e;e++)d.append(a("<li>").addClass(this.cssClasses["suggestions-list-element"]).data("index",e).html(this.formatSuggestion(b[e],this.suggestionValue)));this.suggestionsHolder.empty().append(d),this._showSuggestions()}else this.showMessageOnNoResults&&(this.allowAddingNoSuggestion?this._addTextToSuggestions(this.texts["add-result"].replace("%s",this.suggestionValue),this.cssClasses["add-new-result"]):this.source.length&&this._addTextToSuggestions(this.texts["no-results"]))})},_adjustPosition:function(a){var b,c,d,e,f=this._activateSuggestion(a);f&&(b=f.offset().top,c=this.suggestionsHolder.scrollTop(),e=f.outerHeight(),d=c-e,c>b?this.suggestionsHolder.scrollTop(b):b>d&&this.suggestionsHolder.scrollTop(b-e),this.inputText.val(this.suggestions[a]))},_deactivateSuggestion:function(a){this._getTarget(a).removeClass(this.cssClasses[""]),this.selectedSuggestion=-1},_selectSuggestion:function(){if(this.suggestions.length&&-1!==this.selectedSuggestion)this.addValue(this.suggestions[this.selectedSuggestion])?(this.cancelBlur=!1,this._hideSuggestions(),this.inputText.val("")):(this._addTextToSuggestions(this.texts["existing-item"].replace("%s",this.suggestions[this.selectedSuggestion]),this.cssClasses["existing-item"]),this.cancelBlur=!0);else if(this.allowAddingNoSuggestion){var b=a.trim(this.inputText.val()),c=this.validate(b);"string"==typeof c&&(b=c,c=!0),b.length>=this.minChars&&c?this.addValue(b)?(this.cancelBlur=!1,this._hideSuggestions(),this.inputText.val("")):(this._addTextToSuggestions(this.texts["existing-item"].replace("%s",this.suggestionValue),this.cssClasses["existing-item"]),this.cancelBlur=!0):(this._addTextToSuggestions(this.texts["invalid-format"].replace("%s",this.suggestionValue),this.cssClasses["invalid-format"]),this.cancelBlur=!0)}},_activateSuggestion:function(b){var c=this.cssClasses["highlighted-suggestion"],d=this.suggestionsHolder.find("ul"),e=null;return d.children("."+c).removeClass(c),this.selectedSuggestion=b,-1!==b&&d.children().length>b&&(e=a(d.children().get(b)).addClass(c)),e},_resizeInput:function(){this.inputResizer.text()!==this.inputText.val()&&(this.inputResizer.html(b(this.inputText.val())),this.inputText.width(this.inputResizer.width()+30))},_bindEvents:function(){this.list.on("click",this.proxy(this._onListClick,this)),this.list.on("click","."+this.cssClasses["delete-anchor"],this.proxy(this._onDeleteClick,this)),this.inputText.on("blur",this.proxy(this._hideSuggestions,this)),this.inputText.on("keydown",this.proxy(this._onKeyDown,this)),this.inputText.on("keyup",this.proxy(this._onKeyUp,this)),this.inputText.on("blur keyup keydown",this.proxy(this._resizeInput,this));var a="."+this.cssClasses["suggestions-list-element"]+", ."+this.cssClasses["add-new-result"];this.suggestionsHolder.on("mouseover",a,this.proxy(this._onMouseOver,this)),this.suggestionsHolder.on("mouseout",a,this.proxy(this._deactivateSuggestion,this)),this.suggestionsHolder.on("mousedown",a,this.proxy(this._selectSuggestion,this))},_getCloseAnchor:function(){return a("<span>").text(this.texts["close-text"]).addClass(this.cssClasses["delete-anchor"])},_updateValue:function(){this.el.val(this.currentValue.join(", "))},_getTextFromNode:function(a){return a.find("p").text()},_getNodeFromText:function(b){var c=null,d=this;return this.list.find("."+this.cssClasses["list-token-holder"]).each(function(){return d._getTextFromNode(a(this))===b&&(c=a(this)),null===c}),c},_removeNode:function(a,b){b=b||this._getTextFromNode(a);var c=this.currentValue.indexOf(b);-1!==c&&(a.remove(),this.currentValue.splice(c,1),this._updateValue(),this.emit("remove",b))},_addInitialValues:function(){for(var a=0,b=this.initValue.length;b>a;a++)this.addValue(this.initValue[a])},_isWithinMax:function(){return 0===this.maxSelected||this.currentValue.length<this.maxSelected},_hasReachedMax:function(){return 0!==this.maxSelected||this.currentValue.length===this.maxSelected},_getSuggestionPosition:function(){return{top:this.list.offset().top+this.list.outerHeight(),left:this.list.offset().left,width:this.list.width()}},_showTypeSuggestion:function(){this.showSuggestionOnFocus&&!this.suggestions.length&&this.source.length&&this._addTextToSuggestions(this.texts["type-suggestions"])},_addTextToSuggestions:function(b,c){c=c||"",this.suggestionsHolder.html('<p class="'+c+'">'+a("<div/>").text(b).html()+"</p>"),this._showSuggestions()},_showSuggestions:function(){this.visibleSuggestions||(this.visibleSuggestions=!0,this.suggestionsHolder.css(this._getSuggestionPosition()).show())},_hideSuggestions:function(){return this.cancelBlur?(this.cancelBlur=!1,!1):(this.visibleSuggestions=!1,this.suggestionValue="",this.suggestions=[],this.suggestionsHolder.hide(),void(this.cleanInputOnHide&&this.inputText.val("")))},getValue:function(){return this.currentValue},addValue:function(b){var c=this.currentValue.join(",").toLowerCase().split(",");if(-1===c.indexOf(b.toLowerCase())&&this._isWithinMax()){this.currentValue.push(b);var d=a("<li>").addClass(this.cssClasses["list-token-holder"]),e=a("<p>").text(b);return e.appendTo(d),this._getCloseAnchor().appendTo(d),d.insertBefore(this.listInputHolder),this._updateValue(),this.emit("add",b),this._hasReachedMax()&&this.emit("max",b),!0}return!1},removeValue:function(a){return this._removeNode(this._getNodeFromText(a),a),this.el},init:function(){this.visibleSuggestions=!1,this.currentValue=[],this.suggestions=[],this.suggestionValue="",this.selectedSuggestion=-1,this._setAttributes(),this._createStructure(),this._bindEvents(),this._addInitialValues()}})}(jQuery);